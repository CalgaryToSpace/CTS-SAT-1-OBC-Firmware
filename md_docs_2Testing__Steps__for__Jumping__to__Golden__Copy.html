<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CTS-SAT-1-OBC-Firmware: Testing Steps for Jumping to Golden Copy</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CTS-SAT-1-OBC-Firmware
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Testing Steps for Jumping to Golden Copy</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md95"></a></p>
<h1><a class="anchor" id="autotoc_md96"></a>
Relevant Code</h1>
<ul>
<li><a href="https://github.com/CalgaryToSpace/CTS-SAT-1-OBC-Firmware/pull/255">https://github.com/CalgaryToSpace/CTS-SAT-1-OBC-Firmware/pull/255</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md97"></a>
Relvant Telecommands</h1>
<ul>
<li><code>CTS1+stm32_internal_flash_set_active_flash_bank</code></li>
<li><code>CTS1+stm32_internal_flash_get_active_flash_bank</code></li>
<li><code>CTS1+stm32_internal_flash_get_option_bytes</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md98"></a>
Notes</h1>
<ol type="1">
<li>You will need the stm32-for-vscode extension (up-to-date version). <b>It is important that it is up to date.</b></li>
<li>You will need the <code>STM32CubeProgrammer</code> which is downloadable from the stm32 website.</li>
</ol>
<h1><a class="anchor" id="autotoc_md99"></a>
Testing Steps</h1>
<ol type="1">
<li>Open a serial terminal with the appropriate UART configurations.</li>
<li><code>Clean Build</code> the project and <code>Flash</code> it to your STM32</li>
<li>Ensure that it is working as normal.</li>
<li>Open the STM32CubeProgrammer and connect it to you STM32 Microcontroller<ol type="a">
<li><img src="/docs/assets/Cube_Programmer_Step_1.png" alt="Cube Programmer Step 1, Connect Button" class="inline"/></li>
<li>This will cause your STM to pause. Your serial test will not be receiving anything new. (You can reset your STM32 manually by pressing the reset button on the microcontroller to resume it working while still being connected).</li>
<li>Click the <code>Upload</code> button on the left toolbar. It is the second from the top.<ol type="i">
<li><img src="/docs/assets/Cube_Programmer_Step_2.png" alt="Cube Programmer Step 2, Location of Flashing Screen" class="inline"/></li>
</ol>
</li>
<li>This will show the following screen: <img src="/docs/assets/Cube_Programmer_Step_3.png" alt="Cube Programmer Step 3, Flashing Screen with Numbers " class="inline"/><ol type="i">
<li>Underneath the <code>red</code> 1. drawn, you can select the file path to the firmware .bin file. I would recommend making the following modifications to the firmware.<ol type="A">
<li>Open <code><a class="el" href="rtos__tasks_8c.html">rtos_tasks.c</a></code> and modify the <code>TASK_DEBUG_print_heartbeat</code> function.<ol type="1">
<li>In the while loop at the bottom:</li>
<li><img src="/docs/assets/Modify_Heartbeat.png" alt="Modify Heartbeat message" class="inline"/></li>
<li>Edit line 68 in the screenshot above so that it says: <code>FrontierSat version 2 time: ....</code>. We are only adding the words: <code>version 2</code> infront of <code>FrontierSat</code> and not changing anything else.</li>
</ol>
</li>
</ol>
</li>
<li>Click the <code>Build</code> button.</li>
<li><b>DO NOT FLASH</b></li>
<li>As shown in the above CubeProgrammer screenshot, underneath the <code>red</code> 1., please enter the path to this .bin file. It should be in the build/debug folder of the firmware project.</li>
<li>To the left of the <code>red</code> 2., ensure the value is: <code>0x8100000</code>.</li>
<li>In the checkboxes below the <code>red</code> 2., please ensure <b>Only</b> <b>the</b><code>Verify programming</code> <b>is selected</b>.</li>
<li>Click the <code>Start Program</code> button</li>
<li>Most likely after completing, your stm will be paused. Press the reset button on your STM32 microcontroller.</li>
<li>At this point, it should just like before, running the exact same as before. If you followed my recommendation before, you can confirm this as the heartbeat should be saying <code>FrontierSat time: ...</code></li>
<li>We can now jump to the new program by sending the following telecommand: <code>CTS1+stm32_internal_flash_set_active_flash_bank(2)!</code><ol type="A">
<li>This enables <code>BFB2 i.e Boot From Bank 2</code> which boots from Flash Bank 2.</li>
<li>Following is an example: <img src="/docs/assets/TCMD_Output.png" alt="Telecommand Output" class="inline"/></li>
</ol>
</li>
<li>To go back, we can just send the same telecommand but with 1 as the param: <code>CTS1+stm32_internal_flash_set_active_flash_bank(1)!</code> </li>
</ol>
</li>
</ol>
</li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
