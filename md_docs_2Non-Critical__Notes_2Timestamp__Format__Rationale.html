<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CTS-SAT-1-OBC-Firmware: Timestamp Format Rationale</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CTS-SAT-1-OBC-Firmware
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Timestamp Format Rationale</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md72"></a></p>
<p>Ensure you've read the <a class="el" href="40__Logging_8md.html">/docs/40_Logging.md</a> document, which explains the logging timestamp format, before reading this one.</p>
<p>The following example, copied from <a href="https://github.com/CalgaryToSpace/CTS-SAT-1-OBC-Firmware/pull/106#discussion_r1685270996">a discussion when designing the logging system</a>, provides an example of why the sync+offset+source timestamp format is useful.</p>
<h1><a class="anchor" id="autotoc_md73"></a>
Example</h1>
<h2><a class="anchor" id="autotoc_md74"></a>
Notation</h2>
<ul>
<li>Timestamps will be given in the format returned by <code>TIM_get_timestamp_string()</code>, but in seconds, and at an arbitrary date.</li>
<li>Events will be recorded below in chronological order.</li>
<li>Assume the only sync source is telecommands, right now.</li>
</ul>
<h2><a class="anchor" id="autotoc_md75"></a>
Events</h2>
<ol type="1">
<li>Satellite powers on at time 1712345000, but assumes it's 1970.</li>
<li>Over the next 300 seconds, a few logs are generated. <div class="fragment"><div class="line">0000000000+0001_N [INFO] Satellite Boots</div>
<div class="line">0000000000+0010_N [INFO] Satellite mounts LittleFS.</div>
<div class="line">0000000000+0290_N [INFO] Satellite sends radio beacon.</div>
</div><!-- fragment --></li>
<li>A telecommand timesync happens, and sets the time to <code>1712345300</code>.</li>
<li>The satellite logs the time sync: <div class="fragment"><div class="line">1712345300+0001_T [INFO] Satellite time synced via telecommand to 1712345300 sec since 1970.</div>
</div><!-- fragment --></li>
<li>500 real seconds pass. The satellite clock ticks fast, and thinks 510 secs pass (this would normally be a huge anomaly, but pretend it's a small discrepancy). <div class="fragment"><div class="line">1712345300+0511_T [INFO] A cool action happened and a log message was made</div>
</div><!-- fragment --></li>
<li>A second later, a telecommand syncs the time. <div class="fragment"><div class="line">1712345801+0001_T [INFO] Satellite time synced via telecommand to 1712345801 sec since 1970</div>
</div><!-- fragment --></li>
<li>Observe: Time from Log 5 is 1712345811, and time from log 6 is 1712345802 (when summing the sync+offset). It would seem as though time has "gone backwards", if not for the 2-part logging. However, we can clearly see that the situation is actually just that the clock was running about 10 seconds fast over the 500 secs between syncs, by sorting first by the sync time and then by the offset in the ground station log viewer software (or perhaps Excel haha). This is the non-problematic example of clock drift, and should not generate a warning, as we've designed the logging architecture to handle it.</li>
<li>At real time 1712346000, a new operator comes on shift. This operator is really excited, but has fat fingers, and sends a sync command to 1719346000. This is a big jump forward, but it happens anyway. A warning about a large time shift is logged, but the operator misses it. <div class="fragment"><div class="line">1719346000+0001_T [INFO] Satellite time synced via telecommand to 1719346000 sec since 1970</div>
<div class="line">1719346000+0001_T [WARNING] Satellite observed a large time shift during the resync (this warning is not yet implement, but should be)</div>
</div><!-- fragment --></li>
<li>The satellite logs some telemetry/routine actions over the next 200 seconds. <div class="fragment"><div class="line">1719346000+0003_T [INFO] Routine action 1</div>
<div class="line">1719346000+0020_T [INFO] Routine action 2</div>
<div class="line">1719346000+0200_T [INFO] Routine action 2</div>
</div><!-- fragment --></li>
<li>At real time 1712346200, a periodic resync is performed, this time more carefully. <div class="fragment"><div class="line">1712346200+0001_T [INFO] Satellite time synced via telecommand to 1712346200 sec since 1970</div>
<div class="line">1712346200+0001_T [WARNING] Satellite observed a large time shift during the resync (this warning is not yet implement, but should be)</div>
<div class="line">1712346200+0001_T [WARNING] (my warning) Setting current time to before the last sync.</div>
</div><!-- fragment --></li>
<li>Another 200 seconds pass, and some routine non-telecommand actions on the satellite are logged. <div class="fragment"><div class="line">1712346200+0010_T [INFO] Routine action 10</div>
<div class="line">1712346200+0020_T [INFO] Routine action 11</div>
<div class="line">1712346200+0030_T [INFO] Routine action 12</div>
</div><!-- fragment --></li>
<li>Three days pass. Another operator wants to look at the logs from the past three days, and downlinks them. Due to the lossy nature of the communication link, and automatic repeat requests, the order of the logs is mixed up. Naturally, the logs are re-sorted on the ground using their timestamps. Sorted, the logs look like:</li>
</ol>
<div class="fragment"><div class="line">0000000000+0001_N [INFO] Satellite Boots</div>
<div class="line">0000000000+0010_N [INFO] Satellite mounts LittleFS.</div>
<div class="line">0000000000+0290_N [INFO] Satellite sends radio beacon.</div>
<div class="line">1712345300+0001_T [INFO] Satellite time synced via telecommand to 1712345300 sec since 1970.</div>
<div class="line">1712345300+0511_T [INFO] A cool action happened and a log message was made</div>
<div class="line">1712345801+0001_T [INFO] Satellite time synced via telecommand to 1712345801 sec since 1970</div>
<div class="line">1712346200+0001_T [INFO] Satellite time synced via telecommand to 1712346200 sec since 1970</div>
<div class="line">1712346200+0001_T [WARNING] (my warning) Setting current time to before the last sync.</div>
<div class="line">1712346200+0001_T [WARNING] Satellite observed a large time shift during the resync (this warning is not yet implement, but should be)</div>
<div class="line">1712346200+0010_T [INFO] Routine action 10</div>
<div class="line">1712346200+0020_T [INFO] Routine action 11</div>
<div class="line">1712346200+0030_T [INFO] Routine action 12</div>
<div class="line">1719346000+0001_T [INFO] Satellite time synced via telecommand to 1719346000 sec since 1970</div>
<div class="line">1719346000+0001_T [WARNING] Satellite observed a large time shift during the resync (this warning is not yet implement, but should be)</div>
<div class="line">1719346000+0003_T [INFO] Routine action 1</div>
<div class="line">1719346000+0020_T [INFO] Routine action 2</div>
<div class="line">1719346000+0200_T [INFO] Routine action 2</div>
</div><!-- fragment --><p>See that Routine Actions 1,2,3 appear to have happened <em>after</em> 10,11,12. When analyzing the logs, we see the <code>Setting current time to before the last sync.</code> message, which gives a hint that the logs are likely out-of-order due to that time sync. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
